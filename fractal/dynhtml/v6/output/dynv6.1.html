<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Fractal SBMS Config</title>
  <style>
    body { font-family: sans-serif; background: #f0f0f0; padding: 20px; }
    .tabs { display: flex; overflow-x: auto; margin-bottom: 20px; }
    .tab { background: #ddd; padding: 10px 20px; margin-right: 5px; border-radius: 5px; cursor: pointer; white-space: nowrap; }
    .tab.active { background: #666; color: white; }
    .box { background: white; border: 2px solid #333; padding: 10px; margin: 10px 0; border-radius: 8px; }
    .field-row { display: flex; align-items: center; margin-bottom: 8px; }
    .field-label { width: 150px; font-weight: bold; }
    .field-default { margin-left: 10px; font-style: italic; color: #666; width: 120px; }
    .field-input { flex: 1; margin: 0 5px; }
    .field-buttons button { margin-left: 5px; font-size: 0.9em; }
    #reloadButton { margin-bottom: 20px; padding: 10px 20px; font-size: 1em; }
    #tableSelector { margin-bottom: 10px; padding: 5px; }
    table { width: 100%; background: white; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
  </style>
</head>
<body>
  <h1>Fractal SBMS Config</h1>
  <div class="tabs" id="tabs"></div>
  <button id="reloadButton" onclick="reloadData()">Reload</button>
  <div id="container">Connecting...</div>

<script>
let wsUrl = "ws://localhost:8080";
let wsIp = "localhost";
let wsPort = "8080";
let socket = null;
let connected = false;
let liveData = null;
let currentFrame = "connect";
let currentTable = "volt";

const fakeData = { "frames": { "config": {"boxes": [{"title": "Config","fields": [{"name":"Setting 1","value":"Value1","input":true,"default":"Value1"}]}]},
 "param": {"boxes": [{"title": "Parameters","fields": [{"name":"Param A","value":"10","input":true,"default":"10"}]}]} }};

for (let i = 0; i <= 12; i++) {
  fakeData.frames["rack" + i] = {
    "boxes": [{"title":"Rack " + i,"fields":[{"name":"Rack Setting","value":"Enabled","input":true,"default":"Enabled"}]}],
    "tables": {
      "volt": Array(64).fill(3.7 + 0.01 * i),
      "soc": Array(64).fill(95 + i % 5),
      "soh": Array(64).fill(90 + i % 5),
      "temp": Array(64).fill(25 + i)
    }
  };
}

function buildTabs(data) {
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = '';
  const frames = ["connect", ...Object.keys(data.frames)];
  frames.forEach(frame => {
    const tab = document.createElement('div');
    tab.className = 'tab';
    tab.textContent = frame;
    if (frame === currentFrame) tab.classList.add('active');
    tab.onclick = () => {
      currentFrame = frame;
      buildTabs(data);
      if (frame === "connect") showConnect();
      else createBoxes(data.frames[frame]);
    };
    tabs.appendChild(tab);
  });
}

function showConnect() {
  const container = document.getElementById('container');
  container.innerHTML = `
    <div class="box">
      <h2>Connect to WebSocket</h2>
      <label>IP:</label> <input id="wsIp" value="${wsIp}"><br><br>
      <label>Port:</label> <input id="wsPort" value="${wsPort}"><br><br>
      <button onclick="applyConnect()">Connect</button>
    </div>
  `;
}

function applyConnect() {
  wsIp = document.getElementById('wsIp').value;
  wsPort = document.getElementById('wsPort').value;
  wsUrl = "ws://" + wsIp + ":" + wsPort;
  connectWebSocket();
}

function createBoxes(frameData) {
  const container = document.getElementById('container');
  container.innerHTML = '';

  frameData.boxes.forEach((box, boxIndex) => {
    const div = document.createElement('div');
    div.className = 'box';
    const title = document.createElement('h2');
    title.textContent = box.title;
    div.appendChild(title);

    box.fields.forEach((field, fieldIndex) => {
      const row = document.createElement('div');
      row.className = 'field-row';
      const label = document.createElement('div');
      label.className = 'field-label';
      label.textContent = field.name + ":";
      row.appendChild(label);

      if (field.input) {
        const defVal = document.createElement('div');
        defVal.className = 'field-default';
        defVal.textContent = "Default: " + field.default;
        row.appendChild(defVal);

        const input = document.createElement('input');
        input.type = "text";
        input.value = field.value;
        input.className = 'field-input';
        input.oninput = () => { frameData.boxes[boxIndex].fields[fieldIndex].value = input.value; };
        row.appendChild(input);

        const buttonSet = document.createElement('div');
        buttonSet.className = 'field-buttons';
        const setBtn = document.createElement('button');
        setBtn.textContent = "Set";
        setBtn.onclick = () => {
          if (socket && connected) socket.send(JSON.stringify({ field: field.name, value: input.value }));
          frameData.boxes[boxIndex].fields[fieldIndex].value = input.value;
        };
        buttonSet.appendChild(setBtn);
        const clearBtn = document.createElement('button');
        clearBtn.textContent = "Clear";
        clearBtn.onclick = () => { input.value = ""; frameData.boxes[boxIndex].fields[fieldIndex].value = ""; };
        buttonSet.appendChild(clearBtn);
        const defaultBtn = document.createElement('button');
        defaultBtn.textContent = "Default";
        defaultBtn.onclick = () => { input.value = field.default; frameData.boxes[boxIndex].fields[fieldIndex].value = field.default; };
        buttonSet.appendChild(defaultBtn);
        row.appendChild(buttonSet);
      } else {
        const staticValue = document.createElement('div');
        staticValue.className = 'field-default';
        staticValue.textContent = field.value;
        row.appendChild(staticValue);
      }

      div.appendChild(row);
    });

    container.appendChild(div);
  });

  if (frameData.tables) {
    const tableSelect = document.createElement('select');
    tableSelect.id = 'tableSelector';
    ["volt", "soc", "soh", "temp"].forEach(t => {
      const opt = document.createElement('option');
      opt.value = t;
      opt.textContent = t.toUpperCase();
      if (t === currentTable) opt.selected = true;
      tableSelect.appendChild(opt);
    });
    tableSelect.onchange = () => {
      currentTable = tableSelect.value;
      renderTable(frameData);
    };
    container.appendChild(tableSelect);
    renderTable(frameData);
  }
}
function renderTable(frameData) {
  let table = document.getElementById('batteryTable');
  if (table) table.remove();

  table = document.createElement('table');
  table.id = 'batteryTable';

  const header = table.insertRow();
  for (let i = 0; i < 8; i++) {
    const cell = header.insertCell();
    cell.textContent = `Cell ${i}`;
  }

  const data = frameData.tables[currentTable] || [];
  for (let rowStart = 0; rowStart < data.length; rowStart += 8) {
    const row = table.insertRow();
    for (let i = 0; i < 8; i++) {
      const cell = row.insertCell();
      if (rowStart + i < data.length) {
        const val = data[rowStart + i];
        cell.textContent = val.toFixed(3);
        applyColorCoding(cell, val, currentTable);
      } else {
        cell.textContent = "";
      }
    }
  }

  document.getElementById('container').appendChild(table);
}

function applyColorCoding(cell, value, tableType) {
  if (tableType === "volt") {
    if (value < 3.0 || value > 3.8) {
      cell.style.background = "#ff9999"; // Light Red
    }
  } else if (tableType === "soc") {
    if (value < 20 || value > 100) {
      cell.style.background = "#ffcc66"; // Orange
    }
  } else if (tableType === "soh") {
    if (value < 80) {
      cell.style.background = "#ffff99"; // Yellow
    }
  } else if (tableType === "temp") {
    if (value < 0 || value > 60) {
      cell.style.background = "#ff9999"; // Light Red
    }
  }
}

function yrenderTable(frameData) {
  let table = document.getElementById('batteryTable');
  if (table) table.remove();

  table = document.createElement('table');
  table.id = 'batteryTable';

  const header = table.insertRow();
  for (let i = 0; i < 8; i++) {
    const cell = header.insertCell();
    cell.textContent = `Cell ${i}`;
  }

  const data = frameData.tables[currentTable] || [];
  for (let rowStart = 0; rowStart < data.length; rowStart += 8) {
    const row = table.insertRow();
    for (let i = 0; i < 8; i++) {
      const cell = row.insertCell();
      if (rowStart + i < data.length) {
        cell.textContent = data[rowStart + i].toFixed(3); // Show nicely formatted
      } else {
        cell.textContent = "";
      }
    }
  }

  document.getElementById('container').appendChild(table);
}

function xrenderTable(frameData) {
  let table = document.getElementById('batteryTable');
  if (table) table.remove();

  table = document.createElement('table');
  table.id = 'batteryTable';
  const header = table.insertRow();
  header.insertCell().textContent = "Cell #";
  header.insertCell().textContent = currentTable.toUpperCase();

  (frameData.tables[currentTable] || []).forEach((val, idx) => {
    const row = table.insertRow();
    row.insertCell().textContent = idx;
    row.insertCell().textContent = val;
  });

  document.getElementById('container').appendChild(table);
}

function reloadData() {
  if (liveData) { buildTabs(liveData); createBoxes(liveData.frames[currentFrame]); }
  else { buildTabs(fakeData); createBoxes(fakeData.frames[currentFrame]); }
}

function connectWebSocket() {
  socket = new WebSocket(wsUrl);
  connected = false;

  socket.onopen = () => { connected = true; console.log("Connected"); };
  socket.onmessage = (event) => {
    try { const parsed = JSON.parse(event.data); liveData = parsed; buildTabs(parsed); createBoxes(parsed.frames[currentFrame]); }
    catch (e) { console.error("Parsing WS failed:", e); }
  };
  socket.onerror = () => { console.warn("WebSocket error"); };
  socket.onclose = () => { if (!connected) { liveData = null; buildTabs(fakeData); createBoxes(fakeData.frames[currentFrame]); } };
}

// Start
connectWebSocket();
</script>
</body>
</html>