<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Template Expansion and Editor</title>
</head>
<body>



<h2>Downloads</h2>
<button onclick="downloadFrames()">Download Frames (frames.json)</button>
<button onclick="downloadExpanded()">Download Expanded (expanded.json)</button>
<button onclick="downloadDatapoints()">Download Datapoints (datapoints.txt)</button>

<!-- Popup editor -->
<div id="popup" style="display:none; position:fixed; top:100px; left:100px; background:white; border:2px solid black; padding:20px; border-radius:8px;">
  <textarea id="popupContent" style="width:400px;height:300px;"></textarea><br><br>
  <button onclick="savePopup()">Save</button>
  <button onclick="closePopup()">Cancel</button>
</div>

<h2>Edit Structure</h2>
<div id="editor"></div>

<h2>Expanded Output</h2>
<pre id="output"></pre>

<script>
//--------------------------------------
// Embedded default_frame.json
//--------------------------------------
const frameData = {
  frames: {
    structure: [
      { name: "site", count: 2, template: "site", keys: { "##SN##": "site" } },
      { name: "rack", count: 2, template: "rack", keys: { "##SN##": "site", "##RN##": "rack" } },
      { name: "cell", count: 4, template: "cell", keys: { "##SN##": "site", "##RN##": "rack", "##CN##": "cell" } }
    ],
    templates: {
      site: {
        boxes: [
          {
            title: "Site ##SN## - ##SITE_NAME##",
            fields: [
              { name: "Site ID", value: "Site_##SN##", input: false },
              { name: "Location", value: "HQ ##SN##", input: true }
            ]
          }
        ]
      },
      rack: {
        boxes: [
          {
            title: "Rack ##RN## at Site ##SN##",
            fields: [
              { name: "Rack Serial", value: "Rack_##SN##_##RN##", input: false }
            ]
          }
        ]
      },
      cell: {
        boxes: [
          {
            title: "Cell ##CN## in Rack ##RN## at Site ##SN##",
            fields: [
              { name: "Voltage", value: "3.7", input: false },
              { name: "SOC", value: "95", input: false },
              { name: "Temp", value: "25", input: false }
            ]
          }
        ]
      }
    }
  }
};

let fullData = {};
let datapointsList = [];
let popupSaveCallback = null;

//--------------------------------------
// Generate from Template
//--------------------------------------
function generateFromTemplate(template, substitutions) {
  const copy = JSON.parse(JSON.stringify(template));
  function recursiveReplace(obj) {
    if (typeof obj === 'string') {
      let str = obj;
      for (const [marker, value] of Object.entries(substitutions)) {
        str = str.replaceAll(marker, value);
      }
      return str;
    } else if (Array.isArray(obj)) {
      return obj.map(recursiveReplace);
    } else if (typeof obj === 'object' && obj !== null) {
      const newObj = {};
      for (const key in obj) {
        newObj[key] = recursiveReplace(obj[key]);
      }
      return newObj;
    } else {
      return obj;
    }
  }
  return recursiveReplace(copy);
}

//--------------------------------------
// Expand Frames
//--------------------------------------
function expandFramesUsingTemplates(structureList, templates) {
  const expanded = {};
  function expandLevel(parentObj, substitutions, levelIndex, context) {
    if (levelIndex >= structureList.length) return;
    const config = structureList[levelIndex];
    const template = templates[config.template];
    if (!template) {
      console.error(`Template '${config.template}' not found.`);
      return;
    }
    for (let i = 0; i < config.count; i++) {
      const newSubs = { ...substitutions };
      const newContext = { ...context };
      if (config.keys) {
        for (const [keyMarker, contextName] of Object.entries(config.keys)) {
          newSubs[keyMarker] = i;
          newContext[contextName] = i;
        }
      }
      const newObj = generateFromTemplate(template, newSubs);
      const objName = `${config.name}${i}`;
      parentObj[objName] = newObj;
      if (levelIndex + 1 < structureList.length) {
        const nextLevelName = structureList[levelIndex + 1].name + "s";
        newObj[nextLevelName] = {};
        expandLevel(newObj[nextLevelName], newSubs, levelIndex + 1, newContext);
      }
    }
  }
  expandLevel(expanded, {}, 0, {});
  return expanded;
}

//--------------------------------------
// Extract Datapoints
//--------------------------------------
function extractDatapoints(expanded) {
  const datapoints = new Set();
  function walk(obj, path) {
    if (!obj) return;
    if (obj.boxes) {
      obj.boxes.forEach(box => {
        if (box.fields) {
          box.fields.forEach(field => {
            if (field.name) {
              datapoints.add(`${path}.${field.name}`);
            }
          });
        }
      });
    }
    for (const key in obj) {
      if (typeof obj[key] === 'object' && key !== "boxes") {
        walk(obj[key], path ? `${path}.${key}` : key);
      }
    }
  }
  walk(expanded, "");
  return Array.from(datapoints).sort();
}

//--------------------------------------
// Download Helpers
//--------------------------------------
function downloadFile(filename, content) {
  const blob = new Blob([content], { type: 'application/octet-stream' });
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = filename;
  link.click();
}

function downloadFrames() {
  downloadFile('frames.json', JSON.stringify(fullData.frames, null, 2));
}

function downloadExpanded() {
  downloadFile('expanded.json', JSON.stringify(fullData.expanded, null, 2));
}

function downloadDatapoints() {
  downloadFile('datapoints.txt', datapointsList.join('\n'));
}

//--------------------------------------
// Popup Editor
//--------------------------------------
function openPopup(initialContent, callback) {
  document.getElementById('popupContent').value = JSON.stringify(initialContent, null, 2);
  document.getElementById('popup').style.display = 'block';
  popupSaveCallback = callback;
}

function closePopup() {
  document.getElementById('popup').style.display = 'none';
  popupSaveCallback = null;
}

function savePopup() {
  if (popupSaveCallback) {
    try {
      const newData = JSON.parse(document.getElementById('popupContent').value);
      popupSaveCallback(newData);
    } catch (e) {
      alert("Invalid JSON: " + e.message);
    }
  }
  closePopup();
}

//--------------------------------------
// Editor Buttons
//--------------------------------------
function renderEditor() {
  const editor = document.getElementById('editor');
  editor.innerHTML = "<h3>Structure:</h3>";

  frameData.frames.structure.forEach((item, index) => {
    const div = document.createElement('div');
    div.innerHTML = `[${index}] ${item.name} 
      <button onclick="editStructure(${index})">Edit</button>
      <button onclick="addBefore(${index})">Add Before</button>
      <button onclick="addAfter(${index})">Add After</button>
      <button onclick="deleteStructure(${index})">Delete</button>`;
    editor.appendChild(div);
  });

  editor.innerHTML += "<h3>Templates:</h3>";

  for (const key in frameData.frames.templates) {
    const div = document.createElement('div');
    div.innerHTML = `${key} <button onclick="editTemplate('${key}')">Edit</button>`;
    editor.appendChild(div);
  }
}

// Structure editing
function editStructure(index) {
  openPopup(frameData.frames.structure[index], (newData) => {
    frameData.frames.structure[index] = newData;
    rebuild();
  });
}
function addBefore(index) {
  openPopup({}, (newData) => {
    frameData.frames.structure.splice(index, 0, newData);
    rebuild();
  });
}
function addAfter(index) {
  openPopup({}, (newData) => {
    frameData.frames.structure.splice(index + 1, 0, newData);
    rebuild();
  });
}
function deleteStructure(index) {
  frameData.frames.structure.splice(index, 1);
  rebuild();
}

// Template editing
function editTemplate(key) {
  openPopup(frameData.frames.templates[key], (newData) => {
    frameData.frames.templates[key] = newData;
    rebuild();
  });
}

//--------------------------------------
// Rebuild Everything
//--------------------------------------
function rebuild() {
  fullData = {
    version: "1.0",
    frames: frameData.frames,
    expanded: expandFramesUsingTemplates(frameData.frames.structure, frameData.frames.templates)
  };
  datapointsList = extractDatapoints(fullData.expanded);

  document.getElementById('output').textContent = 
    "Full Data (version + frames + expanded):\n" + JSON.stringify(fullData, null, 2) +
    "\n\nDatapoints List:\n" + datapointsList.join('\n');

  renderEditor();
}

//--------------------------------------
// Start
//--------------------------------------
rebuild();

</script>

</body>
</html>
