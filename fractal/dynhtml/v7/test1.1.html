<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Template Expansion Test</title>
</head>
<body>

<pre id="output"></pre>

<script>
//--------------------------------------
// Your provided templates (default_frame.json)
//--------------------------------------
const frameData = {
  frames: {
    "structure": [
      { "name": "site", "count": 2, "template": "site", "keys": { "##SN##": "site" } },
      { "name": "rack", "count": 2, "template": "rack", "keys": { "##SN##": "site", "##RN##": "rack" } },
      { "name": "cell", "count": 4, "template": "cell", "keys": { "##SN##": "site", "##RN##": "rack", "##CN##": "cell" } }
    ],
    templates: {
      site: {
        boxes: [
          {
            title: "Site ##SN## - ##SITE_NAME##",
            fields: [
              { name: "Site ID", value: "Site_##SN##", input: false },
              { name: "Location", value: "HQ ##SN##", input: true }
            ]
          }
        ]
      },
      rack: {
        boxes: [
          {
            title: "Rack ##RN## at Site ##SN##",
            fields: [
              { name: "Rack Serial", value: "Rack_##SN##_##RN##", input: false }
            ]
          }
        ]
      },
      cell: {
        boxes: [
          {
            title: "Cell ##CN## in Rack ##RN## at Site ##SN##",
            fields: [
              { name: "Voltage", value: "3.7", input: false },
              { name: "SOC", value: "95", input: false },
              { name: "Temp", value: "25", input: false }
            ]
          }
        ]
      }
    }
  }
};

//--------------------------------------
// Structure expansion description
//--------------------------------------
const structure = [
  { name: "site", count: 2, template: "site", keys: { "##SN##": "site" } },
  { name: "rack", count: 2, template: "rack", keys: { "##SN##": "site", "##RN##": "rack" } },
  { name: "cell", count: 4, template: "cell", keys: { "##SN##": "site", "##RN##": "rack", "##CN##": "cell" } }
];

//--------------------------------------
// Generate from Template
//--------------------------------------
function generateFromTemplate(template, substitutions) {
  const copy = JSON.parse(JSON.stringify(template));

  function recursiveReplace(obj) {
    if (typeof obj === 'string') {
      let str = obj;
      for (const [marker, value] of Object.entries(substitutions)) {
        str = str.replaceAll(marker, value);
      }
      return str;
    } else if (Array.isArray(obj)) {
      return obj.map(recursiveReplace);
    } else if (typeof obj === 'object' && obj !== null) {
      const newObj = {};
      for (const key in obj) {
        newObj[key] = recursiveReplace(obj[key]);
      }
      return newObj;
    } else {
      return obj;
    }
  }

  return recursiveReplace(copy);
}

//--------------------------------------
// Expand Frames Using Templates
//--------------------------------------
function expandFramesUsingTemplates(frames, structureList) {
  if (!frames.templates) {
    console.warn("No templates found in frames. Skipping expansion.");
    return;
  }

  function expandLevel(parentObj, substitutions, levelIndex, context) {
    if (levelIndex >= structureList.length) {
      return;
    }

    const config = structureList[levelIndex];
    const template = frames.templates[config.template];

    if (!template) {
      console.error(`Template '${config.template}' not found.`);
      return;
    }

    for (let i = 0; i < config.count; i++) {
      const newSubs = { ...substitutions };
      const newContext = { ...context };

      // Apply all key mappings
      if (config.keys) {
        for (const [keyMarker, contextName] of Object.entries(config.keys)) {
          newSubs[keyMarker] = i;
          newContext[contextName] = i;
        }
      }

      const newObj = generateFromTemplate(template, newSubs);
      const objName = `${config.name}${i}`;

      parentObj[objName] = newObj;

      // Prepare for next level
      if (levelIndex + 1 < structureList.length) {
        const nextLevelName = structureList[levelIndex + 1].name + "s"; // plural
        newObj[nextLevelName] = {};  // Allocate sub-container
        expandLevel(newObj[nextLevelName], newSubs, levelIndex + 1, newContext);
      }
    }
  }

  expandLevel(frames, {}, 0, {});
}

//--------------------------------------
// Extract list of datapoints
//--------------------------------------
function extractDatapoints(frames) {
  const datapoints = new Set(); // Use Set to ensure uniqueness

  function walk(obj, path) {
    if (!obj) return;
    if (obj.boxes) {
      obj.boxes.forEach(box => {
        if (box.fields) {
          box.fields.forEach(field => {
            if (field.name) {
              datapoints.add(`${path}.${field.name}`);
            }
          });
        }
      });
    }
    for (const key in obj) {
      if (typeof obj[key] === 'object' && key !== "boxes") {
        walk(obj[key], path ? `${path}.${key}` : key);
      }
    }
  }

  walk(frames, ""); // Start at root

  return Array.from(datapoints).sort();
}

function xextractDatapoints(frames) {
  const datapoints = [];

  function walk(obj) {
    if (!obj) return;
    if (obj.boxes) {
      obj.boxes.forEach(box => {
        if (box.fields) {
          box.fields.forEach(field => {
            if (field.name) {
              datapoints.push(field.name);
            }
          });
        }
      });
    }
    for (const key in obj) {
      if (typeof obj[key] === 'object') {
        walk(obj[key]);
      }
    }
  }

  walk(frames);

  return datapoints;
}

//--------------------------------------
// Main Test Runner
//--------------------------------------
function runTest()
{
  const frames = { templates: frameData.frames.templates }; // Copy
  expandFramesUsingTemplates(frames, structure);

  const datapoints = extractDatapoints(frames);

  const output = document.getElementById('output');
  output.textContent = "Expanded Frames:\n" + JSON.stringify(frames, null, 2) +
                       "\n\nDatapoints List:\n" + datapoints.join('\n');
}

runTest();

</script>

</body>
</html>
