<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Config Editor</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background: #222;
            color: #eee;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            margin: 0;
            font-size: 18px;
        }
        header .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        header input[type="text"] {
            padding: 4px 6px;
            font-size: 12px;
        }
        header button {
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            background: #f0f0f0;
        }
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            border-right: 1px solid #ccc;
        }
        .tab.active {
            background: #fff;
            border-bottom: 2px solid #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 10px;
            overflow: auto;
            max-height: calc(100vh - 150px);
        }
        .tab-content.active {
            display: block;
        }
        .tab-controls {
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .tab-controls button {
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px 6px;
            text-align: left;
            white-space: nowrap;
        }
        th {
            background: #f9f9f9;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tbody tr:nth-child(even) {
            background: #fafafa;
        }
        tbody tr.new-row {
            background: #e8f5e9;
        }
        tbody tr.deleted-row {
            background: #ffebee;
            text-decoration: line-through;
            opacity: 0.6;
        }
        td[contenteditable="true"] {
            background: #fffef0;
        }
        td[contentselect="true"] {
            background: #fffef0;
        }
        td select {
            width: 100%;
            padding: 0;
            margin: 0;
            border: none;
            background-color: transparent;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            line-height: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
            box-sizing: border-box;
        }
        td select:focus {
            outline: none;
            box-shadow: none;
        }
        td.selectable-cell {
            position: relative;
            padding-right: 16px;
            cursor: pointer;
        }
        td.selectable-cell::after {
            content: "â–¼";
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 9px;
            color: #888;
            pointer-events: none;
        }
        td.selectable-cell:hover::after {
            color: #333;
        }
        td.action-cell {
            text-align: center;
        }
        td.action-cell button {
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
        }
        .status-bar {
            padding: 6px 10px;
            background: #f8f8f8;
            border-top: 1px solid #ddd;
            font-size: 11px;
            color: #555;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        .status-bar span {
            margin-right: 15px;
        }
        .status-ok {
            color: #0a0;
        }
        .status-error {
            color: #a00;
        }
        #pubDefEditor {
            width: 100%;
            height: calc(100vh - 250px);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 1px solid #ccc;
            padding: 10px;
            box-sizing: border-box;
        }
        .pub-def-controls {
            margin-bottom: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .pub-def-controls label {
            font-size: 12px;
        }
        .pub-def-controls input[type="text"] {
            padding: 4px 6px;
            font-size: 12px;
            width: 150px;
        }
    </style>
</head>
<body>
<header>
    <h1>Config Editor</h1>
    <div class="controls">
        <label>CSV Dir:
            <input type="text" id="csvDirInput" value="csv_exports">
        </label>
        <button id="loadBtn">Load from DB</button>
        <button id="saveBtn">Save to DB</button>
        <button id="exportBtn">Export CSV</button>
        <button id="importBtn">Import CSV</button>
    </div>
</header>

<div class="tabs">
    <div class="tab active" data-target="tab-defs">alarm_definitions</div>
    <div class="tab" data-target="tab-levels">alarm_level_actions</div>
    <div class="tab" data-target="tab-limits">limits_values</div>
    <div class="tab" data-target="tab-pub-defs">pub_definitions</div>
    <div class="tab" data-target="tab-target">target</div>
</div>

<!-- alarm_definitions -->
<div id="tab-defs" class="tab-content active">
    <div class="tab-controls">
        <button id="addAlarmBtn">âž• Add Alarm</button>
        <span style="color: #666; font-size: 11px;">Click "Delete" on a row to mark for deletion. Save to apply changes.</span>
    </div>
    <table id="defsTable">
        <thead>
            <tr>
                <th>alarm_num</th>
                <th>alarm_name</th>
                <th>num_levels</th>
                <th>measured_variable</th>
                <th>limits_structure</th>
                <th>comparison_type</th>
                <th>alarm_variable</th>
                <th>latched_variable</th>
                <th>notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- alarm_level_actions -->
<div id="tab-levels" class="tab-content">
    <table id="levelsTable">
        <thead>
            <tr>
                <th>alarm_num</th>
                <th>alarm_name</th>
                <th>level</th>
                <th>enabled</th>
                <th>duration</th>
                <th>actions</th>
                <th>notes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- limits_values -->
<div id="tab-limits" class="tab-content">
    <table id="limitsTable">
        <thead>
            <tr>
                <th>limits_structure</th>
                <th>alarm_name</th>
                <th>level1_limit</th>
                <th>level2_limit</th>
                <th>level3_limit</th>
                <th>hysteresis</th>
                <th>last_updated</th>
                <th>notes</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- pub_definitions -->
<div id="tab-pub-defs" class="tab-content">
    <div class="pub-def-controls">
        <label>File Name:
            <input type="text" id="pubDefFileName" value="hithium_vars.json">
        </label>
        <label>Directory:
            <input type="text" id="pubDefDirectory" value="pub_definitions">
        </label>
        <button id="loadPubDefBtn">Load Pub Def</button>
        <button id="savePubDefBtn">Save Pub Def</button>
    </div>
    <textarea id="pubDefEditor"></textarea>
</div>

<!-- target tab (restored behavior) -->
<div id="tab-target" class="tab-content">
    <div class="tab-controls">
        <label>Target WS URL:
            <input type="text" id="targetWsUrl" value="ws://192.168.86.209:9001" style="min-width: 260px;">
        </label>
        <button id="addTargetVarBtn">âž• Add Variable</button>
        <button id="saveTargetBtn">Save Target Config</button>
        <button id="loadTargetBtn">Load Target Config</button>
    </div>
    <table id="targetVarsTable">
        <thead>
            <tr>
                <th>var_name</th>
                <th>address / path</th>
                <th>datatype</th>
                <th>notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="status-bar">
    <span id="statusText">Ready.</span>
</div>

<script>
const alarmApiBase  = location.origin + '/api/alarms';
const pubDefApiBase = location.origin + '/api/pub_defs';
const targetApiBase = location.origin + '/api/alarms/target';

const COMPARISON_OPTIONS = [
    'greater_than',
    'less_than',
    'equal',
    'not_equal',
    'greater_or_equal',
    'less_or_equal',
    'aggregate'
];

function makeComparisonTypeEditable(td) {
    if (td.querySelector('select')) return;
    const current = (td.textContent || '').trim() || 'greater_than';
    const select = document.createElement('select');
    COMPARISON_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        if (opt === current) o.selected = true;
        select.appendChild(o);
    });
    td.textContent = '';
    td.appendChild(select);
    select.focus();
    const finalize = () => {
        const value = select.value;
        td.removeChild(select);
        td.textContent = value;
    };
    select.addEventListener('blur', finalize);
    select.addEventListener('change', finalize);
}

function setStatus(msg, isError = false) {
    const el = document.getElementById('statusText');
    el.textContent = msg;
    el.className = isError ? 'status-error' : 'status-ok';
}

// Tabs
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.target).classList.add('active');

        if (tab.dataset.target === 'tab-pub-defs') {
            loadPubDef();
        }
        if (tab.dataset.target === 'tab-target') {
            loadTargetConfig();
        }
    });
});

// ---- alarm_definitions rendering / collect ----
function renderDefs(data) {
    const tbody = document.querySelector('#defsTable tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        const cols = ['alarm_num','alarm_name','num_levels','measured_variable','limits_structure','comparison_type','alarm_variable','latched_variable','notes'];
        cols.forEach(col => {
            const td = document.createElement('td');
            td.textContent = row[col] ?? '';
            td.setAttribute('data-col', col);
            if (col !== 'alarm_num') {
                if (col === 'comparison_type') {
                    td.classList.add('selectable-cell');
                    td.addEventListener('click', () => makeComparisonTypeEditable(td));
                    td.setAttribute('contentselect', 'true');
                } else {
                    td.setAttribute('contenteditable', 'true');
                }
            }
            tr.appendChild(td);
        });
        const actionTd = document.createElement('td');
        actionTd.className = 'action-cell';
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ðŸ—‘ï¸ Delete';
        deleteBtn.onclick = () => toggleDeleteRow(tr);
        actionTd.appendChild(deleteBtn);
        tr.appendChild(actionTd);
        tbody.appendChild(tr);
    });
}

function renderLevels(data) {
    const tbody = document.querySelector('#levelsTable tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        const cols = ['alarm_num','alarm_name','level','enabled','duration','actions','notes'];
        cols.forEach(col => {
            const td = document.createElement('td');
            let val = row[col];
            if (col === 'enabled') val = row[col] ? 1 : 0;
            td.textContent = val ?? '';
            td.setAttribute('data-col', col);
            if (col !== 'alarm_num' && col !== 'alarm_name' && col !== 'level') {
                td.setAttribute('contenteditable', 'true');
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

function renderLimits(data) {
    const tbody = document.querySelector('#limitsTable tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        const cols = ['limits_structure','alarm_name','level1_limit','level2_limit','level3_limit','hysteresis','last_updated','notes'];
        cols.forEach(col => {
            const td = document.createElement('td');
            td.textContent = row[col] ?? '';
            td.setAttribute('data-col', col);
            if (col !== 'limits_structure' && col !== 'alarm_name' && col !== 'last_updated') {
                td.setAttribute('contenteditable', 'true');
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

function addNewAlarm() {
    const tbody = document.querySelector('#defsTable tbody');
    const existingRows = tbody.querySelectorAll('tr:not(.deleted-row)');
    let maxAlarmNum = -1;
    existingRows.forEach(tr => {
        const numCell = tr.querySelector('td[data-col="alarm_num"]');
        if (numCell) {
            const num = parseInt(numCell.textContent);
            if (!isNaN(num) && num > maxAlarmNum) maxAlarmNum = num;
        }
    });
    const newAlarmNum = maxAlarmNum + 1;

    const tr = document.createElement('tr');
    tr.className = 'new-row';
    const cols = ['alarm_num','alarm_name','num_levels','measured_variable','limits_structure','comparison_type','alarm_variable','latched_variable','notes'];
    const defaults = {
        alarm_num: newAlarmNum,
        alarm_name: 'New Alarm',
        num_levels: 1,
        measured_variable: '',
        limits_structure: '',
        comparison_type: 'greater_than',
        alarm_variable: '',
        latched_variable: '',
        notes: ''
    };
    cols.forEach(col => {
        const td = document.createElement('td');
        td.textContent = defaults[col];
        td.setAttribute('data-col', col);
        if (col !== 'alarm_num') td.setAttribute('contenteditable', 'true');
        tr.appendChild(td);
    });
    const actionTd = document.createElement('td');
    actionTd.className = 'action-cell';
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'ðŸ—‘ï¸ Delete';
    deleteBtn.onclick = () => toggleDeleteRow(tr);
    actionTd.appendChild(deleteBtn);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
    setStatus('New alarm added. Edit and click "Save to DB" to persist.', false);
}

function toggleDeleteRow(tr) {
    if (tr.classList.contains('deleted-row')) {
        tr.classList.remove('deleted-row');
        setStatus('Row unmarked for deletion.', false);
    } else {
        tr.classList.add('deleted-row');
        setStatus('Row marked for deletion. Click "Save to DB" to apply.', false);
    }
}

function collectDefs() {
    const rows = [];
    document.querySelectorAll('#defsTable tbody tr:not(.deleted-row)').forEach(tr => {
        const obj = {};
        tr.querySelectorAll('td[data-col]').forEach(td => {
            const col = td.getAttribute('data-col');
            let val = td.textContent.trim();
            if (col === 'alarm_num' || col === 'num_levels') {
                val = val === '' ? null : Number(val);
            }
            obj[col] = val === '' ? null : val;
        });
        if (obj.alarm_num == null || !obj.alarm_name || obj.num_levels == null || isNaN(obj.num_levels)) {
            console.warn('Skipping invalid alarm_def row:', obj);
            return;
        }
        rows.push(obj);
    });
    return rows;
}

function collectLevels() {
    const rows = [];
    document.querySelectorAll('#levelsTable tbody tr').forEach(tr => {
        const obj = {};
        tr.querySelectorAll('td').forEach(td => {
            const col = td.getAttribute('data-col');
            if (col === 'alarm_name') return;
            let val = td.textContent.trim();
            if (col === 'alarm_num' || col === 'level') {
                val = val === '' ? null : Number(val);
            } else if (col === 'enabled') {
                val = val === '' ? false : (val === '1' || val.toLowerCase() === 'true');
            } else if (col === 'duration') {
                val = val === '' ? null : Number(val);
            }
            obj[col] = val === '' ? null : val;
        });
        if (obj.alarm_num != null && obj.level != null) rows.push(obj);
    });
    return rows;
}

function collectLimits() {
    const rows = [];
    document.querySelectorAll('#limitsTable tbody tr').forEach(tr => {
        const obj = {};
        tr.querySelectorAll('td').forEach(td => {
            const col = td.getAttribute('data-col');
            if (col === 'alarm_name') return;
            let val = td.textContent.trim();
            if (['level1_limit','level2_limit','level3_limit','hysteresis'].includes(col)) {
                val = val === '' ? null : Number(val);
            }
            obj[col] = val === '' ? null : val;
        });
        if (obj.limits_structure) rows.push(obj);
    });
    return rows;
}

// ---- Alarm API ----
async function loadFromDB() {
    setStatus('Loading from /api/alarms/config ...');
    try {
        const res = await fetch(alarmApiBase + '/config');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        renderDefs(data.alarm_definitions || []);
        renderLevels(data.alarm_level_actions || []);
        renderLimits(data.limits_values || []);
        setStatus('Loaded configuration from DB.', false);
    } catch (err) {
        console.error(err);
        setStatus('Error loading config: ' + err.message, true);
    }
}

async function saveToDB() {
    const payload = {
        alarm_definitions: collectDefs(),
        alarm_level_actions: collectLevels(),
        limits_values: collectLimits()
    };
    setStatus('Saving to /api/alarms/config ...');
    try {
        const res = await fetch(alarmApiBase + '/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Saved configuration to DB. Reloading...', false);
        await loadFromDB();
    } catch (err) {
        console.error(err);
        setStatus('Error saving config: ' + err.message, true);
    }
}

async function exportCSV() {
    const dir = document.getElementById('csvDirInput').value.trim() || 'csv_exports';
    setStatus('Exporting CSV to dir: ' + dir + ' ...');
    try {
        const res = await fetch(alarmApiBase + '/export-csv', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ directory: dir })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Exported CSV to: ' + data.message, false);
    } catch (err) {
        console.error(err);
        setStatus('Error exporting CSV: ' + err.message, true);
    }
}

async function importCSV() {
    const dir = document.getElementById('csvDirInput').value.trim() || 'csv_exports';
    setStatus('Importing CSV from dir: ' + dir + ' ...');
    try {
        const res = await fetch(alarmApiBase + '/import-csv', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ directory: dir })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Imported CSV from: ' + dir + '. Reloading ...', false);
        await loadFromDB();
    } catch (err) {
        console.error(err);
        setStatus('Error importing CSV: ' + err.message, true);
    }
}

// ---- Pub Def API ----
async function loadPubDef() {
    const fileName  = document.getElementById('pubDefFileName').value.trim();
    const directory = document.getElementById('pubDefDirectory').value.trim() || 'pub_definitions';
    const editor    = document.getElementById('pubDefEditor');
    if (!fileName) {
        setStatus('Please enter a file name for Pub Definitions.', true);
        return;
    }
    setStatus(`Loading ${fileName} from ${directory} ...`);
    try {
        const res = await fetch(pubDefApiBase + '/load', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ file_name: fileName, directory })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        editor.value = JSON.stringify(data, null, 4);
        setStatus(`Loaded ${fileName}.`, false);
    } catch (err) {
        console.error(err);
        editor.value = '';
        setStatus(`Error loading ${fileName}: ${err.message}`, true);
    }
}

async function savePubDef() {
    const fileName  = document.getElementById('pubDefFileName').value.trim();
    const directory = document.getElementById('pubDefDirectory').value.trim() || 'pub_definitions';
    const editor    = document.getElementById('pubDefEditor');
    const jsonString = editor.value;
    if (!fileName) {
        setStatus('Please enter a file name for Pub Definitions.', true);
        return;
    }
    if (!jsonString) {
        setStatus('Pub Definition editor is empty. Nothing to save.', true);
        return;
    }
    let jsonData;
    try { jsonData = JSON.parse(jsonString); }
    catch (e) {
        setStatus('Invalid JSON in editor: ' + e.message, true);
        return;
    }
    setStatus(`Saving ${fileName} to ${directory} ...`);
    try {
        const res = await fetch(pubDefApiBase + '/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ file_name: fileName, directory, data: jsonData })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus(`Saved ${fileName}.`, false);
    } catch (err) {
        console.error(err);
        setStatus(`Error saving ${fileName}: ${err.message}`, true);
    }
}

// ---- Target tab (WS URL + variables list) ----
function renderTargetVars(vars) {
    const tbody = document.querySelector('#targetVarsTable tbody');
    tbody.innerHTML = '';
    (vars || []).forEach(v => {
        const tr = document.createElement('tr');
        ['var_name','address','datatype','notes'].forEach(col => {
            const td = document.createElement('td');
            td.textContent = v[col] ?? '';
            td.setAttribute('data-col', col);
            td.setAttribute('contenteditable', 'true');
            tr.appendChild(td);
        });
        const actionTd = document.createElement('td');
        actionTd.className = 'action-cell';
        const delBtn = document.createElement('button');
        delBtn.textContent = 'ðŸ—‘ï¸ Delete';
        delBtn.onclick = () => tr.remove();
        actionTd.appendChild(delBtn);
        tr.appendChild(actionTd);
        tbody.appendChild(tr);
    });
}

function collectTargetVars() {
    const vars = [];
    document.querySelectorAll('#targetVarsTable tbody tr').forEach(tr => {
        const obj = {};
        tr.querySelectorAll('td[data-col]').forEach(td => {
            const col = td.getAttribute('data-col');
            obj[col] = td.textContent.trim();
        });
        if (!obj.var_name && !obj.address) return;
        vars.push(obj);
    });
    return vars;
}

function addTargetVarRow() {
    const tbody = document.querySelector('#targetVarsTable tbody');
    const tr = document.createElement('tr');
    const defaults = {
        var_name: '',
        address:  '',
        datatype: 'float',
        notes:    ''
    };
    ['var_name','address','datatype','notes'].forEach(col => {
        const td = document.createElement('td');
        td.textContent = defaults[col];
        td.setAttribute('data-col', col);
        td.setAttribute('contenteditable', 'true');
        tr.appendChild(td);
    });
    const actionTd = document.createElement('td');
    actionTd.className = 'action-cell';
    const delBtn = document.createElement('button');
    delBtn.textContent = 'ðŸ—‘ï¸ Delete';
    delBtn.onclick = () => tr.remove();
    actionTd.appendChild(delBtn);
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
    setStatus('New target variable row added.', false);
}

async function loadTargetConfig() {
    setStatus('Loading target config ...');
    try {
        const res = await fetch(targetApiBase + '/config');  // GET /api/alarms/target/config
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        document.getElementById('targetWsUrl').value = data.ws_url || 'ws://192.168.86.209:9001';
        renderTargetVars(data.variables || []);
        setStatus('Loaded target config.', false);
    } catch (err) {
        console.error(err);
        setStatus('Error loading target config: ' + err.message, true);
    }
}

async function saveTargetConfig() {
    const wsUrl = document.getElementById('targetWsUrl').value.trim();
    const variables = collectTargetVars();
    const payload = { ws_url: wsUrl, variables };
    setStatus('Saving target config ...');
    try {
        const res = await fetch(targetApiBase + '/config', {  // POST /api/alarms/target/config
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Saved target config.', false);
    } catch (err) {
        console.error(err);
        setStatus('Error saving target config: ' + err.message, true);
    }
}

// Wire buttons
document.getElementById('loadBtn').addEventListener('click', loadFromDB);
document.getElementById('saveBtn').addEventListener('click', saveToDB);
document.getElementById('exportBtn').addEventListener('click', exportCSV);
document.getElementById('importBtn').addEventListener('click', importCSV);
document.getElementById('addAlarmBtn').addEventListener('click', addNewAlarm);

document.getElementById('loadPubDefBtn').addEventListener('click', loadPubDef);
document.getElementById('savePubDefBtn').addEventListener('click', savePubDef);

document.getElementById('addTargetVarBtn').addEventListener('click', addTargetVarRow);
document.getElementById('saveTargetBtn').addEventListener('click', saveTargetConfig);
document.getElementById('loadTargetBtn').addEventListener('click', loadTargetConfig);

// Initial load
loadFromDB();
</script>
</body>
</html>