<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Variable Registry Sync Monitor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #00d9ff;
            font-size: 2em;
        }
        
        .servers {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .server-card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #0f3460;
        }
        
        .server-card.primary {
            border-color: #00d9ff;
        }
        
        .server-card.secondary {
            border-color: #ff6b6b;
        }
        
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .server-title {
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .server-card.primary .server-title {
            color: #00d9ff;
        }
        
        .server-card.secondary .server-title {
            color: #ff6b6b;
        }
        
        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .status-badge.connected {
            background: #2ecc71;
            color: white;
        }
        
        .status-badge.disconnected {
            background: #e74c3c;
            color: white;
        }
        
        .server-url {
            color: #aaa;
            font-size: 0.9em;
            margin-bottom: 15px;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .stat-box {
            background: #0f3460;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
            transition: all 0.3s;
        }
        
        .stat-box.synced {
            border: 2px solid #2ecc71;
            animation: pulse 2s infinite;
        }
        
        .stat-box.out-of-sync {
            border: 2px solid #e74c3c;
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.7);
            }
            50% {
                box-shadow: 0 0 0 10px rgba(46, 204, 113, 0);
            }
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #00d9ff;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #aaa;
            margin-top: 5px;
        }
        
        .activity-feed {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #0f3460;
            max-height: 500px;
            overflow-y: auto;
        }
        
        .activity-header {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #00d9ff;
        }
        
        .activity-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 5px;
            border-left: 4px solid;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .activity-item.created {
            background: rgba(46, 204, 113, 0.1);
            border-color: #2ecc71;
        }
        
        .activity-item.updated {
            background: rgba(241, 196, 15, 0.1);
            border-color: #f1c40f;
        }
        
        .activity-item.deleted {
            background: rgba(231, 76, 60, 0.1);
            border-color: #e74c3c;
        }
        
        .activity-time {
            font-size: 0.85em;
            color: #aaa;
        }
        
        .activity-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.85em;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .activity-type.created {
            background: #2ecc71;
            color: white;
        }
        
        .activity-type.updated {
            background: #f1c40f;
            color: #333;
        }
        
        .activity-type.deleted {
            background: #e74c3c;
            color: white;
        }
        
        .activity-details {
            margin-top: 8px;
            font-size: 0.95em;
        }
        
        .activity-name {
            font-weight: bold;
            color: #00d9ff;
        }
        
        .activity-meta {
            color: #aaa;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #00d9ff;
            color: #1a1a2e;
        }
        
        .btn-primary:hover {
            background: #00b8d4;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            flex: 1;
        }
        
        input {
            flex: 1;
            padding: 10px;
            border: 2px solid #0f3460;
            border-radius: 5px;
            background: #16213e;
            color: #eee;
            font-size: 1em;
        }
        
        input:focus {
            outline: none;
            border-color: #00d9ff;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”„ Variable Registry Sync Monitor</h1>
        
        <div class="servers">
            <div class="server-card primary">
                <div class="server-header">
                    <div class="server-title">Primary Server</div>
                    <div class="status-badge" id="primary-status">Disconnected</div>
                </div>
                <div class="server-url" id="primary-url">Not connected</div>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="primary-vars">0</div>
                        <div class="stat-label">Variables</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="primary-version">0</div>
                        <div class="stat-label">System Version</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="primary-events">0</div>
                        <div class="stat-label">Events</div>
                    </div>
                </div>
            </div>
            
            <div class="server-card secondary">
                <div class="server-header">
                    <div class="server-title">Secondary Server</div>
                    <div class="status-badge" id="secondary-status">Disconnected</div>
                </div>
                <div class="server-url" id="secondary-url">Not connected</div>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-value" id="secondary-vars">0</div>
                        <div class="stat-label">Variables</div>
                    </div>
                    <div class="stat-box" id="version-sync-box">
                        <div class="stat-value" id="secondary-version">0</div>
                        <div class="stat-label">System Version</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="secondary-synced">0</div>
                        <div class="stat-label">Synced</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <div class="input-group">
                <input type="text" id="var-name" placeholder="Variable name (e.g., test_variable_1)">
                <input type="text" id="var-category" placeholder="Category (config/prot/oper)" value="oper">
                <input type="text" id="var-locator" placeholder="Locator (e.g., system.global)" value="system.global">
            </div>
            <button class="btn btn-primary" onclick="createVariable()">Create Variable</button>
            <button class="btn btn-danger" onclick="clearActivity()">Clear Activity</button>
        </div>
        
        <div class="activity-feed">
            <div class="activity-header">Activity Feed</div>
            <div id="activity-list"></div>
        </div>
    </div>
    
    <script>
        const PRIMARY_URL = 'http://192.168.86.51:8902';
        const SECONDARY_URL = 'http://192.168.86.51:8903';
        
        let primaryWs = null;
        let secondaryWs = null;
        let eventCount = 0;
        let syncedCount = 0;
        
        // Connect to primary server
        function connectPrimary() {
            const wsUrl = PRIMARY_URL.replace('http://', 'ws://') + '/ws/sync';
            primaryWs = new WebSocket(wsUrl);
            
            primaryWs.onopen = () => {
                console.log('âœ“ Connected to primary server');
                document.getElementById('primary-status').textContent = 'Connected';
                document.getElementById('primary-status').className = 'status-badge connected';
                document.getElementById('primary-url').textContent = PRIMARY_URL;
                updateStats();
            };
            
            primaryWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type !== 'pong') {
                    handleEvent(data, 'primary');
                }
            };
            
            primaryWs.onclose = () => {
                console.log('âœ— Disconnected from primary server');
                document.getElementById('primary-status').textContent = 'Disconnected';
                document.getElementById('primary-status').className = 'status-badge disconnected';
                setTimeout(connectPrimary, 3000);
            };
            
            primaryWs.onerror = (error) => {
                console.error('Primary WebSocket error:', error);
            };
        }
        
        // Connect to secondary server
        function connectSecondary() {
            const wsUrl = SECONDARY_URL.replace('http://', 'ws://') + '/ws/sync';
            secondaryWs = new WebSocket(wsUrl);
            
            secondaryWs.onopen = () => {
                console.log('âœ“ Connected to secondary server');
                document.getElementById('secondary-status').textContent = 'Connected';
                document.getElementById('secondary-status').className = 'status-badge connected';
                document.getElementById('secondary-url').textContent = SECONDARY_URL;
                updateStats();
            };
            
            secondaryWs.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type !== 'pong') {
                    handleEvent(data, 'secondary');
                }
            };
            
            secondaryWs.onclose = () => {
                console.log('âœ— Disconnected from secondary server');
                document.getElementById('secondary-status').textContent = 'Disconnected';
                document.getElementById('secondary-status').className = 'status-badge disconnected';
                setTimeout(connectSecondary, 3000);
            };
            
            secondaryWs.onerror = (error) => {
                console.error('Secondary WebSocket error:', error);
            };
        }
        
        // Handle events
        function handleEvent(data, source) {
            if (data.type === 'created' || data.type === 'updated' || data.type === 'deleted') {
                eventCount++;
                if (source === 'secondary') {
                    syncedCount++;
                }
                addActivity(data, source);
                updateStats();
            }
        }
        
        // Add activity to feed
        function addActivity(data, source) {
            const activityList = document.getElementById('activity-list');
            const item = document.createElement('div');
            item.className = `activity-item ${data.type}`;
            
            const time = new Date(data.timestamp).toLocaleTimeString();
            const variable = data.variable;
            
            item.innerHTML = `
                <div>
                    <span class="activity-time">${time}</span>
                    <span class="activity-type ${data.type}">${data.type.toUpperCase()}</span>
                    <span style="color: ${source === 'primary' ? '#00d9ff' : '#ff6b6b'}; margin-left: 10px; font-weight: bold;">
                        [${source.toUpperCase()}]
                    </span>
                </div>
                <div class="activity-details">
                    <span class="activity-name">${variable.name}</span>
                </div>
                <div class="activity-meta">
                    Category: ${variable.category} | Locator: ${variable.locator || 'none'} | 
                    Version: v${variable.variable_version} (sys: ${variable.system_version})
                </div>
            `;
            
            activityList.insertBefore(item, activityList.firstChild);
            
            // Keep only last 50 items
            while (activityList.children.length > 50) {
                activityList.removeChild(activityList.lastChild);
            }
        }
        
        // Update statistics
        async function updateStats() {
            try {
                // Primary stats
                const primaryRes = await fetch(`${PRIMARY_URL}/api/health`);
                const primaryData = await primaryRes.json();
                const primaryVersion = primaryData.system_version;
                
                document.getElementById('primary-vars').textContent = primaryData.variable_count;
                document.getElementById('primary-version').textContent = primaryVersion;
                document.getElementById('primary-events').textContent = eventCount;
                
                // Secondary stats
                const secondaryRes = await fetch(`${SECONDARY_URL}/api/health`);
                const secondaryData = await secondaryRes.json();
                const secondaryVersion = secondaryData.system_version;
                
                document.getElementById('secondary-vars').textContent = secondaryData.variable_count;
                document.getElementById('secondary-version').textContent = secondaryVersion;
                document.getElementById('secondary-synced').textContent = syncedCount;
                
                // Check version sync status
                const versionBox = document.getElementById('version-sync-box');
                if (primaryVersion === secondaryVersion) {
                    versionBox.className = 'stat-box synced';
                    versionBox.title = 'âœ“ Versions in sync';
                } else {
                    versionBox.className = 'stat-box out-of-sync';
                    versionBox.title = `âš  Out of sync (primary: ${primaryVersion}, secondary: ${secondaryVersion})`;
                }
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }
        
        // Create variable on primary server
        async function createVariable() {
            const name = document.getElementById('var-name').value.trim();
            const category = document.getElementById('var-category').value.trim() || 'oper';
            const locator = document.getElementById('var-locator').value.trim() || 'system.global';
            
            if (!name) {
                alert('Please enter a variable name');
                return;
            }
            
            try {
                const response = await fetch(`${PRIMARY_URL}/api/variables`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        display_name: name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                        units: '',
                        description: `Test variable created at ${new Date().toLocaleTimeString()}`,
                        category: category,
                        locator: locator,
                        source_system: 'web-ui'
                    })
                });
                
                if (response.ok) {
                    document.getElementById('var-name').value = '';
                    console.log('âœ“ Variable created successfully');
                } else {
                    const error = await response.json();
                    alert(`Error: ${error.detail}`);
                }
            } catch (error) {
                console.error('Error creating variable:', error);
                alert('Failed to create variable');
            }
        }
        
        // Clear activity feed
        function clearActivity() {
            document.getElementById('activity-list').innerHTML = '';
            eventCount = 0;
            syncedCount = 0;
            updateStats();
        }
        
        // Initialize
        connectPrimary();
        connectSecondary();
        setInterval(updateStats, 5000);
        
        // Allow Enter key to create variable
        document.getElementById('var-name').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                createVariable();
            }
        });
    </script>
</body>
</html>