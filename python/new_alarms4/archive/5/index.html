<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Alarm Config Editor</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
        }
        header {
            background: #222;
            color: #eee;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            margin: 0;
            font-size: 18px;
        }
        header .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        header input[type="text"] {
            padding: 4px 6px;
            font-size: 12px;
        }
        header button {
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        .tabs {
            display: flex;
            border-bottom: 1px solid #ccc;
            background: #f0f0f0;
        }
        .tab {
            padding: 8px 12px;
            cursor: pointer;
            border-right: 1px solid #ccc;
        }
        .tab.active {
            background: #fff;
            border-bottom: 2px solid #007bff;
            font-weight: bold;
        }
        .tab-content {
            display: none;
            padding: 10px;
            overflow: auto;
            max-height: calc(100vh - 150px);
        }
        .tab-content.active {
            display: block;
        }
        .tab-controls {
            margin-bottom: 8px;
            display: flex;
            gap: 8px;
        }
        .tab-controls button {
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 12px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 4px 6px;
            text-align: left;
            white-space: nowrap;
        }
        th {
            background: #f9f9f9;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        tbody tr:nth-child(even) {
            background: #fafafa;
        }
        tbody tr.new-row {
            background: #e8f5e9;
        }
        tbody tr.deleted-row {
            background: #ffebee;
            text-decoration: line-through;
            opacity: 0.6;
        }
        td[contenteditable="true"] {
            background: #fffef0;
        }
        td[contentselect="true"] {
            background: #fffef0;
        }
        td select {
            width: 100%;
            padding: 0;
            margin: 0;
            border: none;
            background-color: transparent;
            font-family: inherit;
            font-size: inherit;
            color: inherit;
            line-height: inherit;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
            box-sizing: border-box;
        }
        td select:focus {
            outline: none;
        }
        td.selectable-cell {
            position: relative;
            padding-right: 16px;
            cursor: pointer;
        }
        td.selectable-cell::after {
            content: "â–¼";
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 9px;
            color: #888;
            pointer-events: none;
        }
        td.selectable-cell:hover::after {
            color: #333;
        }
        td.action-cell {
            text-align: center;
        }
        td.action-cell button {
            padding: 2px 6px;
            font-size: 11px;
            cursor: pointer;
        }
        .status-bar {
            padding: 6px 10px;
            background: #f8f8f8;
            border-top: 1px solid #ddd;
            font-size: 11px;
            color: #555;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
        .status-bar span {
            margin-right: 15px;
        }
        .status-ok {
            color: #0a0;
        }
        .status-error {
            color: #a00;
        }
        
        /* Target tab specific styles */
        .target-section {
            margin-bottom: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: #fafafa;
        }
        .target-section h3 {
            margin-top: 0;
            font-size: 14px;
            color: #333;
        }
        .target-form {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .target-form label {
            font-size: 12px;
        }
        .target-form input[type="text"],
        .target-form input[type="number"] {
            padding: 4px 6px;
            font-size: 12px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        .target-form input[type="checkbox"] {
            margin-left: 4px;
        }
        .target-form button {
            padding: 4px 8px;
            font-size: 12px;
            cursor: pointer;
        }
        #targetVarsTable td[contenteditable="true"] {
            background: #fffef0;
            cursor: text;
        }
    </style>
</head>
<body>
<header>
    <h1>Alarm Config Editor</h1>
    <div class="controls">
        <label>CSV Dir:
            <input type="text" id="csvDirInput" value="csv_exports">
        </label>
        <button id="loadBtn">Load from DB</button>
        <button id="saveBtn">Save to DB</button>
        <button id="exportBtn">Export CSV</button>
        <button id="importBtn">Import CSV</button>
    </div>
</header>

<div class="tabs">
    <div class="tab active" data-target="tab-defs">alarm_definitions</div>
    <div class="tab" data-target="tab-levels">alarm_level_actions</div>
    <div class="tab" data-target="tab-limits">limits_values</div>
    <div class="tab" data-target="tab-target">target</div>
</div>

<div id="tab-defs" class="tab-content active">
    <div class="tab-controls">
        <button id="addAlarmBtn">âž• Add Alarm</button>
        <span style="color: #666; font-size: 11px;">Click "Delete" on a row to mark for deletion. Save to apply changes.</span>
    </div>
    <table id="defsTable">
        <thead>
            <tr>
                <th>alarm_num</th>
                <th>alarm_name</th>
                <th>num_levels</th>
                <th>measured_variable</th>
                <th>limits_structure</th>
                <th>comparison_type</th>
                <th>alarm_variable</th>
                <th>latched_variable</th>
                <th>notes</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- filled by JS -->
        </tbody>
    </table>
</div>

<div id="tab-levels" class="tab-content">
    <table id="levelsTable">
        <thead>
            <tr>
                <th>alarm_num</th>
                <th>alarm_name</th>
                <th>level</th>
                <th>enabled</th>
                <th>duration</th>
                <th>actions</th>
                <th>notes</th>
            </tr>
        </thead>
        <tbody>
            <!-- filled by JS -->
        </tbody>
    </table>
</div>

<div id="tab-limits" class="tab-content">
    <table id="limitsTable">
        <thead>
            <tr>
                <th>limits_structure</th>
                <th>alarm_name</th>
                <th>level1_limit</th>
                <th>level2_limit</th>
                <th>level3_limit</th>
                <th>hysteresis</th>
                <th>last_updated</th>
                <th>notes</th>
            </tr>
        </thead>
        <tbody>
            <!-- filled by JS -->
        </tbody>
    </table>
</div>

<div id="tab-target" class="tab-content">
    <div class="target-section">
        <h3>Target Connection</h3>
        <div class="target-form">
            <label>IP: <input type="text" id="targetIp" value="127.0.0.1" /></label>
            <label>Port: <input type="number" id="targetPort" value="8080" /></label>
            <label>Secure: <input type="checkbox" id="targetSecure" /></label>
            <button onclick="saveTargetConfig()">ðŸ’¾ Save Config</button>
            <button onclick="loadTargetConfig()">ðŸ”„ Load Config</button>
        </div>
    </div>

    <div class="target-section">
        <h3>Variable Get/Set</h3>
        <!-- NEW: Variable list selection controls -->
        <div class="tab-controls">
            <label style="font-size: 12px;">
                Var List:
                <select id="varListSelect" style="font-size: 12px; padding: 2px 4px; min-width: 160px;">
                    <!-- options filled by JS -->
                </select>
            </label>
            <button onclick="reloadVarListOptions()">ðŸ”„ Refresh Lists</button>
            <button onclick="loadSelectedVarList()">ðŸ“‚ Load List</button>
            <button onclick="saveCurrentVarList()">ðŸ’¾ Save List</button>
        </div>
        <div class="tab-controls">
            <button onclick="addTargetVar()">âž• Add Variable</button>
            <span style="color: #666; font-size: 11px;">Type variable name or shared mem ref, then click Get/Set</span>
        </div>
        <table id="targetVarsTable">
            <thead>
                <tr>
                    <th>Variable Name / Ref</th>
                    <th>sm_name</th>
                    <th>reg_type</th>
                    <th>offset</th>
                    <th>num</th>
                    <th>write_data (JSON array)</th>
                    <th>read_data (JSON array)</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                <!-- filled by JS -->
            </tbody>
        </table>
    </div>
</div>

<div class="status-bar">
    <span id="statusText">Ready.</span>
</div>

<script>
const apiBase = location.origin + '/api/alarms';

const COMPARISON_OPTIONS = [
    'greater_than',
    'less_than',
    'equal',
    'not_equal',
    'greater_or_equal',
    'less_or_equal',
    'aggregate'
];

function makeComparisonTypeEditable(td) {
    if (td.querySelector('select')) return;

    const current = (td.textContent || '').trim() || 'greater_than';

    const select = document.createElement('select');
    COMPARISON_OPTIONS.forEach(opt => {
        const o = document.createElement('option');
        o.value = opt;
        o.textContent = opt;
        if (opt === current) {
            o.selected = true;
        }
        select.appendChild(o);
    });

    td.textContent = '';
    td.appendChild(select);
    select.focus();

    const finalize = () => {
        const value = select.value;
        td.removeChild(select);
        td.textContent = value;
    };

    select.addEventListener('blur', finalize);
    select.addEventListener('change', finalize);
}

function setStatus(msg, isError = false) {
    const el = document.getElementById('statusText');
    el.textContent = msg;
    el.className = isError ? 'status-error' : 'status-ok';
}

// Simple tab switching
document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.target).classList.add('active');
    });
});

// Render helpers
function renderDefs(data) {
    const tbody = document.querySelector('#defsTable tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        const cols = ['alarm_num','alarm_name','num_levels','measured_variable','limits_structure','comparison_type','alarm_variable','latched_variable','notes'];
        cols.forEach(col => {
            const td = document.createElement('td');
            td.textContent = row[col] ?? '';
            td.setAttribute('data-col', col);
            if (col !== 'alarm_num') {
                if (col === 'comparison_type') {
                    td.classList.add('selectable-cell');
                    td.addEventListener('click', () => {
                    makeComparisonTypeEditable(td);
                    });
                    td.setAttribute('contentselect', 'true');
                } else {
                    td.setAttribute('contenteditable', 'true');
                }
            }
            tr.appendChild(td);
        });
        
        const actionTd = document.createElement('td');
        actionTd.className = 'action-cell';
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ðŸ—‘ï¸ Delete';
        deleteBtn.onclick = () => toggleDeleteRow(tr);
        actionTd.appendChild(deleteBtn);
        tr.appendChild(actionTd);
        
        tbody.appendChild(tr);
    });
}

function renderLevels(data) {
    const tbody = document.querySelector('#levelsTable tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        const cols = ['alarm_num','alarm_name','level','enabled','duration','actions','notes'];
        cols.forEach(col => {
            const td = document.createElement('td');
            let val = row[col];
            if (col === 'enabled') {
                val = row[col] ? 1 : 0;
            }
            td.textContent = val ?? '';
            td.setAttribute('data-col', col);
            if (col !== 'alarm_num' && col !== 'alarm_name' && col !== 'level') {
                td.setAttribute('contenteditable', 'true');
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

function renderLimits(data) {
    const tbody = document.querySelector('#limitsTable tbody');
    tbody.innerHTML = '';
    data.forEach(row => {
        const tr = document.createElement('tr');
        const cols = ['limits_structure','alarm_name','level1_limit','level2_limit','level3_limit','hysteresis','last_updated','notes'];
        cols.forEach(col => {
            const td = document.createElement('td');
            td.textContent = row[col] ?? '';
            td.setAttribute('data-col', col);
            if (col !== 'limits_structure' && col !== 'alarm_name' && col !== 'last_updated') {
                td.setAttribute('contenteditable', 'true');
            }
            tr.appendChild(td);
        });
        tbody.appendChild(tr);
    });
}

function addNewAlarm() {
    const tbody = document.querySelector('#defsTable tbody');
    const existingRows = tbody.querySelectorAll('tr:not(.deleted-row)');
    
    let maxAlarmNum = -1;
    existingRows.forEach(tr => {
        const numCell = tr.querySelector('td[data-col="alarm_num"]');
        if (numCell) {
            const num = parseInt(numCell.textContent);
            if (!isNaN(num) && num > maxAlarmNum) {
                maxAlarmNum = num;
            }
        }
    });
    const newAlarmNum = maxAlarmNum + 1;
    
    const tr = document.createElement('tr');
    tr.className = 'new-row';
    
    const cols = ['alarm_num','alarm_name','num_levels','measured_variable','limits_structure','comparison_type','alarm_variable','latched_variable','notes'];
    const defaults = {
        'alarm_num': newAlarmNum,
        'alarm_name': 'New Alarm',
        'num_levels': 1,
        'measured_variable': '',
        'limits_structure': '',
        'comparison_type': 'greater_than',
        'alarm_variable': '',
        'latched_variable': '',
        'notes': ''
    };
    
    cols.forEach(col => {
        const td = document.createElement('td');
        td.textContent = defaults[col];
        td.setAttribute('data-col', col);
        if (col !== 'alarm_num') {
            td.setAttribute('contenteditable', 'true');
        }
        tr.appendChild(td);
    });
    
    const actionTd = document.createElement('td');
    actionTd.className = 'action-cell';
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = 'ðŸ—‘ï¸ Delete';
    deleteBtn.onclick = () => toggleDeleteRow(tr);
    actionTd.appendChild(deleteBtn);
    tr.appendChild(actionTd);
    
    tbody.appendChild(tr);
    setStatus('New alarm added. Edit and click "Save to DB" to persist.', false);
}

function toggleDeleteRow(tr) {
    if (tr.classList.contains('deleted-row')) {
        tr.classList.remove('deleted-row');
        setStatus('Row unmarked for deletion.', false);
    } else {
        tr.classList.add('deleted-row');
        setStatus('Row marked for deletion. Click "Save to DB" to apply.', false);
    }
}

function collectDefs() {
    const rows = [];
    document.querySelectorAll('#defsTable tbody tr:not(.deleted-row)').forEach(tr => {
        const obj = {};
        tr.querySelectorAll('td[data-col]').forEach(td => {
            const col = td.getAttribute('data-col');
            let val = td.textContent.trim();

            if (col === 'alarm_num' || col === 'num_levels') {
                val = val === '' ? null : Number(val);
            }

            obj[col] = (val === '' ? null : val);
        });

        if (obj.alarm_num == null) {
            console.warn('Skipping row without alarm_num:', obj);
            return;
        }
        if (!obj.alarm_name || obj.alarm_name.toString().trim() === '') {
            console.warn('Skipping row without alarm_name:', obj);
            return;
        }
        if (obj.num_levels == null || isNaN(obj.num_levels)) {
            console.warn('Skipping row without valid num_levels:', obj);
            return;
        }

        rows.push(obj);
    });
    return rows;
}

function collectLevels() {
    const rows = [];
    document.querySelectorAll('#levelsTable tbody tr').forEach(tr => {
        const obj = {};
        tr.querySelectorAll('td').forEach(td => {
            const col = td.getAttribute('data-col');
            if (col === 'alarm_name') return;
            
            let val = td.textContent.trim();
            if (col === 'alarm_num' || col === 'level') {
                val = val === '' ? null : Number(val);
            } else if (col === 'enabled') {
                val = val === '' ? false : (val === '1' || val.toLowerCase() === 'true');
            } else if (col === 'duration') {
                val = val === '' ? null : Number(val);
            }
            obj[col] = val === '' ? null : val;
        });
        if (obj.alarm_num != null && obj.level != null) {
            rows.push(obj);
        }
    });
    return rows;
}

function collectLimits() {
    const rows = [];
    document.querySelectorAll('#limitsTable tbody tr').forEach(tr => {
        const obj = {};
        tr.querySelectorAll('td').forEach(td => {
            const col = td.getAttribute('data-col');
            if (col === 'alarm_name') return;
            
            let val = td.textContent.trim();
            if (['level1_limit','level2_limit','level3_limit','hysteresis'].includes(col)) {
                val = val === '' ? null : Number(val);
            }
            obj[col] = val === '' ? null : val;
        });
        if (obj.limits_structure) {
            rows.push(obj);
        }
    });
    return rows;
}

async function loadFromDB() {
    setStatus('Loading from /api/alarms/config ...');
    try {
        const res = await fetch(apiBase + '/config');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        renderDefs(data.alarm_definitions || []);
        renderLevels(data.alarm_level_actions || []);
        renderLimits(data.limits_values || []);
        setStatus('Loaded configuration from DB.', false);
    } catch (err) {
        console.error(err);
        setStatus('Error loading config: ' + err.message, true);
    }
}

async function saveToDB() {
    const payload = {
        alarm_definitions: collectDefs(),
        alarm_level_actions: collectLevels(),
        limits_values: collectLimits()
    };
    setStatus('Saving to /api/alarms/config ...');
    try {
        const res = await fetch(apiBase + '/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Saved configuration to DB. Reloading...', false);
        await loadFromDB();
    } catch (err) {
        console.error(err);
        setStatus('Error saving config: ' + err.message, true);
    }
}

async function exportCSV() {
    const dir = document.getElementById('csvDirInput').value.trim() || 'csv_exports';
    setStatus('Exporting CSV to dir: ' + dir + ' ...');
    try {
        const res = await fetch(apiBase + '/export-csv', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ directory: dir })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Exported CSV to: ' + data.message, false);
    } catch (err) {
        console.error(err);
        setStatus('Error exporting CSV: ' + err.message, true);
    }
}

async function importCSV() {
    const dir = document.getElementById('csvDirInput').value.trim() || 'csv_exports';
    setStatus('Importing CSV from dir: ' + dir + ' ...');
    try {
        const res = await fetch(apiBase + '/import-csv', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ directory: dir })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Imported CSV from: ' + dir + '. Reloading ...', false);
        await loadFromDB();
    } catch (err) {
        console.error(err);
        setStatus('Error importing CSV: ' + err.message, true);
    }
}

// --- Target tab functions ---

async function loadTargetConfig() {
    setStatus('Loading target config...');
    try {
        const res = await fetch(apiBase + '/target/config');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const config = await res.json();
        document.getElementById('targetIp').value = config.ip;
        document.getElementById('targetPort').value = config.port;
        document.getElementById('targetSecure').checked = config.secure;
        setStatus('Target config loaded.', false);
    } catch (err) {
        console.error(err);
        setStatus('Error loading target config: ' + err.message, true);
    }
}

async function saveTargetConfig() {
    const config = {
        ip: document.getElementById('targetIp').value,
        port: parseInt(document.getElementById('targetPort').value),
        secure: document.getElementById('targetSecure').checked
    };
    setStatus('Saving target config...');
    try {
        const res = await fetch(apiBase + '/target/config', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(config)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));
        setStatus('Target config saved.', false);
    } catch (err) {
        console.error(err);
        setStatus('Error saving target config: ' + err.message, true);
    }
}

function addTargetVar() {
    const tbody = document.querySelector('#targetVarsTable tbody');
    const tr = document.createElement('tr');
    
    const cols = ['var_name', 'sm_name', 'reg_type', 'offset', 'num', 'write_data', 'read_data'];
    const defaults = {
        'var_name': 'rtos:hold:alarm_limits',
        'sm_name': 'rtos',
        'reg_type': 'mb_hold',
        'offset': '9',
        'num': '4',
        'write_data': '[]',
        'read_data': '[]'
    };
    
    cols.forEach(col => {
        const td = document.createElement('td');
        td.textContent = defaults[col];
        td.setAttribute('data-col', col);
        // Only write_data and first 5 cols are editable, read_data is read-only
        if (col !== 'read_data') {
            td.setAttribute('contenteditable', 'true');
        } else {
            td.style.background = '#f0f0f0';
            td.style.color = '#666';
        }
        tr.appendChild(td);
    });
    
    const actionTd = document.createElement('td');
    actionTd.className = 'action-cell';
    
    const getBtn = document.createElement('button');
    getBtn.textContent = 'ðŸ“¥ Get';
    getBtn.onclick = () => getTargetData(tr);
    actionTd.appendChild(getBtn);
    
    const setBtn = document.createElement('button');
    setBtn.textContent = 'ðŸ“¤ Set';
    setBtn.onclick = () => setTargetData(tr);
    actionTd.appendChild(setBtn);
    
    const delBtn = document.createElement('button');
    delBtn.textContent = 'ðŸ—‘ï¸';
    delBtn.onclick = () => tr.remove();
    actionTd.appendChild(delBtn);
    
    tr.appendChild(actionTd);
    tbody.appendChild(tr);
}

async function getTargetData(tr) {
    const cells = tr.querySelectorAll('td[data-col]');
    const payload = {
        sm_name: cells[1].textContent.trim(),
        reg_type: cells[2].textContent.trim(),
        offset: cells[3].textContent.trim(),
        num: parseInt(cells[4].textContent.trim())
    };
    
    setStatus('Getting data from target...');
    try {
        const res = await fetch(apiBase + '/target/get', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
        
        // Update read_data column (index 6)
        cells[6].textContent = JSON.stringify(data.read_data || []);
        setStatus('Got data: ' + JSON.stringify(data), false);
    } catch (err) {
        console.error(err);
        setStatus('Error getting data: ' + err.message, true);
    }
}

async function setTargetData(tr) {
    const cells = tr.querySelectorAll('td[data-col]');
    const writeDataStr = cells[5].textContent.trim();
    let writeDataArray;
    try {
        writeDataArray = JSON.parse(writeDataStr);
    } catch (e) {
        setStatus('Invalid JSON in write_data field', true);
        return;
    }
    
    const payload = {
        sm_name: cells[1].textContent.trim(),
        reg_type: cells[2].textContent.trim(),
        offset: cells[3].textContent.trim(),
        write_data: writeDataArray
    };
    
    setStatus('Setting data on target...');
    try {
        const res = await fetch(apiBase + '/target/set', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || ('HTTP ' + res.status));
        
        setStatus('Set data: ' + JSON.stringify(data), false);
    } catch (err) {
        console.error(err);
        setStatus('Error setting data: ' + err.message, true);
    }
}

// --- Variable list handling ---


// --- Variable list handling ---

const pubApiBase = location.origin + '/api/pub_defs';

async function reloadVarListOptions() {
    setStatus('Loading variable lists...');
    const select = document.getElementById('varListSelect');
    if (!select) return;

    try {
        const res = await fetch(pubApiBase + '/list');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const data = await res.json();
        const files = data.files || [];

        select.innerHTML = '<option value="">(select a file)</option>';
        
        if (files.length === 0) {
            const opt = document.createElement('option');
            opt.value = '';
            opt.textContent = '(no var_lists/*.json found)';
            select.appendChild(opt);
            setStatus('No var list files found in var_lists.', true);
            return;
        }

        files.forEach(f => {
            const opt = document.createElement('option');
            opt.value = f;
            opt.textContent = f;
            select.appendChild(opt);
        });

        setStatus('Variable lists loaded from ' + (data.directory || 'var_lists') + '.', false);
    } catch (err) {
        console.error(err);
        setStatus('Error loading var list files: ' + err.message, true);
    }
}

// Interpret a variable list JSON and populate targetVarsTable.
// Format: array of table objects, each with "table" and "items" array
function populateTargetVarsFromVarList(varListJson) {
    const tbody = document.querySelector('#targetVarsTable tbody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!Array.isArray(varListJson)) {
        console.warn('Var list JSON is not an array:', varListJson);
        setStatus('Var list format error: expected array of tables.', true);
        return;
    }

    let totalVars = 0;

    varListJson.forEach(tableObj => {
        if (!tableObj.items || !Array.isArray(tableObj.items)) {
            console.warn('Table object missing items[]:', tableObj);
            return;
        }

        tableObj.items.forEach(item => {
            const varName = item.name || '';
            const smName = item.sm_name || 'rtos';
            const regType = item.reg_type || 'mb_hold';
            const offset = item.offset != null ? String(item.offset) : '0';
            const num = item.num != null ? String(item.num) : '1';

            // Prefer write_data, fallback to read_data, then empty array
            let writeDataArray = [];
            if (Array.isArray(item.write_data)) {
                writeDataArray = item.write_data;
            } else if (Array.isArray(item.read_data)) {
                writeDataArray = item.read_data;
            }

            const tr = document.createElement('tr');
            
            // IMPORTANT: Must match the exact column structure of addTargetVar()
            const cols = ['var_name', 'sm_name', 'reg_type', 'offset', 'num', 'write_data', 'read_data'];
            const defaults = {
                var_name: varName,
                sm_name: smName,
                reg_type: regType,
                offset: offset,
                num: num,
                write_data: JSON.stringify(writeDataArray),
                read_data: '[]'  // Start empty, will be filled by Get
            };

            cols.forEach(col => {
                const td = document.createElement('td');
                td.textContent = defaults[col] ?? '';
                td.setAttribute('data-col', col);
                
                // Only write_data and first 5 cols are editable, read_data is read-only
                if (col !== 'read_data') {
                    td.setAttribute('contenteditable', 'true');
                } else {
                    td.style.background = '#f0f0f0';
                    td.style.color = '#666';
                }
                tr.appendChild(td);
            });

            const actionTd = document.createElement('td');
            actionTd.className = 'action-cell';

            const getBtn = document.createElement('button');
            getBtn.textContent = 'ðŸ“¥ Get';
            getBtn.onclick = () => getTargetData(tr);
            actionTd.appendChild(getBtn);

            const setBtn = document.createElement('button');
            setBtn.textContent = 'ðŸ“¤ Set';
            setBtn.onclick = () => setTargetData(tr);
            actionTd.appendChild(setBtn);

            const delBtn = document.createElement('button');
            delBtn.textContent = 'ðŸ—‘ï¸';
            delBtn.onclick = () => tr.remove();
            actionTd.appendChild(delBtn);

            tr.appendChild(actionTd);
            tbody.appendChild(tr);
            totalVars++;
        });
    });

    setStatus('Loaded ' + totalVars + ' variable(s) from list.', false);
}

// async function loadSelectedVarList() {
//     const select = document.getElementById('varListSelect');
//     if (!select || !select.value) {
//         setStatus('No variable list selected.', true);
//         return;
//     }

//     const fileName = select.value;
//     setStatus('Loading var list: ' + fileName + ' ...');

//     try {
//         const res = await fetch(pubApiBase + '/load_var_list', {
//             method: 'POST',
//             headers: {'Content-Type': 'application/json'},
//             body: JSON.stringify({ file_name: fileName })
//         });
//         const data = await res.json();
//         if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));

//         populateTargetVarsFromVarList(data);
//     } catch (err) {
//         console.error(err);
//         setStatus('Error loading var list: ' + err.message, true);
//     }
// }

// Collect current target vars table into var list JSON format
function collectTargetVarsAsVarList() {
    const tbody = document.querySelector('#targetVarsTable tbody');
    if (!tbody) return [];

    const items = [];
    tbody.querySelectorAll('tr').forEach(tr => {
        const cells = tr.querySelectorAll('td[data-col]');
        if (cells.length < 7) return;

        const varName = cells[0].textContent.trim();
        const smName = cells[1].textContent.trim();
        const regType = cells[2].textContent.trim();
        const offset = cells[3].textContent.trim();
        const num = parseInt(cells[4].textContent.trim()) || 1;
        const writeDataStr = cells[5].textContent.trim();
        const readDataStr = cells[6].textContent.trim();

        let writeData = [];
        let readData = [];

        try {
            writeData = JSON.parse(writeDataStr);
        } catch (e) {
            console.warn('Invalid write_data JSON for var:', varName);
        }

        try {
            readData = JSON.parse(readDataStr);
        } catch (e) {
            // read_data can be empty, that's ok
        }

        items.push({
            name: varName,
            sm_name: smName,
            reg_type: regType,
            offset: offset,
            num: num,
            write_data: writeData,
            read_data: readData
        });
    });

    // Wrap in the expected format: array with one table object
    return [{
        table: 'target_vars',
        items: items
    }];
}

// Save current target vars table to a var list JSON file
async function saveCurrentVarList() {
    const sel = document.getElementById('varListSelect');
    //let fileName = sel ? sel.value.trim() : '';

    let currentFileName = sel ? sel.value.trim() : '';
    
    // Always prompt, but use current selection as default
    let fileName = prompt('Enter a name for this variable list:', currentFileName || 'my_vars.json');

    if (!fileName || fileName.trim() === '') {
        setStatus('Save cancelled: no file name.', true);
        return;
    }
    
    fileName = fileName.trim();
    // Ensure .json extension
    if (!fileName.endsWith('.json')) {
        fileName += '.json';
    }


    const varListData = collectTargetVarsAsVarList();

    setStatus('Saving var list: ' + fileName + ' ...');

    try {
        const res = await fetch(pubApiBase + '/save', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                file_name: fileName,
                directory: 'var_lists',  // Save to var_lists/ directory
                data: varListData
            })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));

        setStatus('Var list saved: ' + fileName, false);

        // Refresh dropdown and select the saved file
        //await refreshVarLists();
        await reloadVarListOptions();

        if (sel) sel.value = fileName;

    } catch (err) {
        console.error(err);
        setStatus('Error saving var list: ' + err.message, true);
    }
}

// const pubApiBase = location.origin + '/api/pub_defs';

// async function reloadVarListOptions() {
//     setStatus('Loading variable lists...');
//     const select = document.getElementById('varListSelect');
//     if (!select) return;

//     try {
//         const res = await fetch(pubApiBase + '/list');
//         if (!res.ok) throw new Error('HTTP ' + res.status);
//         const data = await res.json();
//         const files = data.files || [];

//         select.innerHTML = '';
//         if (files.length === 0) {
//             const opt = document.createElement('option');
//             opt.value = '';
//             opt.textContent = '(no var_lists/*.json found)';
//             select.appendChild(opt);
//             setStatus('No var list files found in var_lists.', true);
//             return;
//         }

//         files.forEach(f => {
//             const opt = document.createElement('option');
//             opt.value = f;
//             opt.textContent = f;
//             select.appendChild(opt);
//         });

//         setStatus('Variable lists loaded from ' + (data.directory || 'var_lists') + '.', false);
//     } catch (err) {
//         console.error(err);
//         setStatus('Error loading var list files: ' + err.message, true);
//     }
// }
// // Interpret a variable list JSON and populate targetVarsTable.
// // Assumes a simple structure like:
// // {
// //   "pub": "config",
// //   "items": [
// //      { "name": "alarm_limits", "src": "rtos:hold:alarm_limits", "type": "u16x4", "write_data": [0,0,0,0], "read_data": [0,0,0,0] },
// //      ...
// //   ]
// // }
// function populateTargetVarsFromVarList(varListJson) {
//     const tbody = document.querySelector('#targetVarsTable tbody');
//     if (!tbody) return;
//     tbody.innerHTML = '';

//     if (!Array.isArray(varListJson)) {
//         console.warn('Var list JSON is not an array:', varListJson);
//         setStatus('Var list format error: expected array of tables.', true);
//         return;
//     }

//     let totalVars = 0;
//     // if (!varListJson || !Array.isArray(varListJson.items)) {
//     //     console.warn('Var list JSON has no items[]:', varListJson);
//     //     setStatus('Var list has no items[] section.', true);
//     //     return;
//     // }

//     varListJson.forEach(tableObj => {
//             if (!tableObj.items || !Array.isArray(tableObj.items)) {
//                 console.warn('Table object missing items[]:', tableObj);
//                 return;
//             }

//             tableObj.items.forEach(item => {
//                 const varName = item.name || '';
//                 const smName = item.sm_name || 'rtos';
//                 const regType = item.reg_type || 'mb_hold';
//                 const offset = item.offset != null ? String(item.offset) : '0';
//                 const num = item.num != null ? String(item.num) : '1';

//                 // Prefer read_data, fallback to write_data, then empty array
//                 let dataArray = [];
//                 if (Array.isArray(item.read_data)) {
//                     dataArray = item.read_data;
//                 } else if (Array.isArray(item.write_data)) {
//                     dataArray = item.write_data;
//                 }

//                 const tr = document.createElement('tr');
//                 const cols = ['var_name', 'sm_name', 'reg_type', 'offset', 'num', 'data'];
//                 const defaults = {
//                     var_name: varName,
//                     sm_name: smName,
//                     reg_type: regType,
//                     offset: offset,
//                     num: num,
//                     data: JSON.stringify(dataArray)
//                 };

//                 cols.forEach(col => {
//                     const td = document.createElement('td');
//                     td.textContent = defaults[col] ?? '';
//                     td.setAttribute('data-col', col);
//                     td.setAttribute('contenteditable', 'true');
//                     tr.appendChild(td);
//                 });

//                 const actionTd = document.createElement('td');
//                 actionTd.className = 'action-cell';

//                 const getBtn = document.createElement('button');
//                 getBtn.textContent = 'ðŸ“¥ Get';
//                 getBtn.onclick = () => getTargetData(tr);
//                 actionTd.appendChild(getBtn);

//                 const setBtn = document.createElement('button');
//                 setBtn.textContent = 'ðŸ“¤ Set';
//                 setBtn.onclick = () => setTargetData(tr);
//                 actionTd.appendChild(setBtn);

//                 const delBtn = document.createElement('button');
//                 delBtn.textContent = 'ðŸ—‘ï¸';
//                 delBtn.onclick = () => tr.remove();
//                 actionTd.appendChild(delBtn);

//                 tr.appendChild(actionTd);
//                 tbody.appendChild(tr);
//                 totalVars++;
//             });
//         });

//         setStatus('Loaded ' + totalVars + ' variable(s) from list.', false);
//     }

    // varListJson.items.forEach(item => {
    //     // You may need to adapt this mapping to your actual schema in hithium_vars.json
    //     const varName = item.src || item.name || '';
    //     const smName = (item.sm_name || 'rtos');
    //     const regType = (item.reg_type || 'mb_hold');
    //     const offset = (item.offset != null ? String(item.offset) : '0');
    //     const num = (item.size != null ? String(item.size) : '1');

    //     // Prefer read_data as default data shown in UI; fallback to write_data; then empty array.
    //     let dataArray = [];
    //     if (Array.isArray(item.read_data)) {
    //         dataArray = item.read_data;
    //     } else if (Array.isArray(item.write_data)) {
    //         dataArray = item.write_data;
    //     }

    //     const tr = document.createElement('tr');
    //     const cols = ['var_name', 'sm_name', 'reg_type', 'offset', 'num', 'data'];
    //     const defaults = {
    //         var_name: varName,
    //         sm_name: smName,
    //         reg_type: regType,
    //         offset: offset,
    //         num: num,
    //         data: JSON.stringify(dataArray)
    //     };

    //     cols.forEach(col => {
    //         const td = document.createElement('td');
    //         td.textContent = defaults[col] ?? '';
    //         td.setAttribute('data-col', col);
    //         td.setAttribute('contenteditable', 'true');
    //         tr.appendChild(td);
    //     });

    //     const actionTd = document.createElement('td');
    //     actionTd.className = 'action-cell';

    //     const getBtn = document.createElement('button');
    //     getBtn.textContent = 'ðŸ“¥ Get';
    //     getBtn.onclick = () => getTargetData(tr);
    //     actionTd.appendChild(getBtn);

    //     const setBtn = document.createElement('button');
    //     setBtn.textContent = 'ðŸ“¤ Set';
    //     setBtn.onclick = () => setTargetData(tr);
    //     actionTd.appendChild(setBtn);

    //     const delBtn = document.createElement('button');
    //     delBtn.textContent = 'ðŸ—‘ï¸';
    //     delBtn.onclick = () => tr.remove();
    //     actionTd.appendChild(delBtn);

    //     tr.appendChild(actionTd);
    //     tbody.appendChild(tr);
    // });

//     setStatus('Loaded ' + varListJson.items.length + ' variable(s) from list.', false);
// }

async function loadSelectedVarList() {
    const select = document.getElementById('varListSelect');
    if (!select || !select.value) {
        setStatus('No variable list selected.', true);
        return;
    }

    const fileName = select.value;
    setStatus('Loading var list: ' + fileName + ' ...');

    try {
        const res = await fetch(pubApiBase + '/load_var_list', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ file_name: fileName })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));

        populateTargetVarsFromVarList(data);
    } catch (err) {
        console.error(err);
        setStatus('Error loading var list: ' + err.message, true);
    }
}
// async function loadSelectedVarList() {
//     const select = document.getElementById('varListSelect');
//     if (!select || !select.value) {
//         setStatus('No variable list selected.', true);
//         return;
//     }

//     const fileName = select.value;
//     setStatus('Loading var list: ' + fileName + ' ...');

//     try {
//         const res = await fetch(pubApiBase + '/load_var_list', {
//             method: 'POST',
//             headers: {'Content-Type': 'application/json'},
//             body: JSON.stringify({ file_name: fileName })
//         });
//         const data = await res.json();
//         if (!res.ok) throw new Error(data.message || ('HTTP ' + res.status));

//         populateTargetVarsFromVarList(data);
//     } catch (err) {
//         console.error(err);
//         setStatus('Error loading var list: ' + err.message, true);
//     }
// }

// Wire buttons
document.getElementById('loadBtn').addEventListener('click', loadFromDB);
document.getElementById('saveBtn').addEventListener('click', saveToDB);
document.getElementById('exportBtn').addEventListener('click', exportCSV);
document.getElementById('importBtn').addEventListener('click', importCSV);
document.getElementById('addAlarmBtn').addEventListener('click', addNewAlarm);

// Initial load
loadFromDB();
loadTargetConfig();
reloadVarListOptions();

</script>
</body>
</html>