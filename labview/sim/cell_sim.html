<!DOCTYPE html>
<html>
<head>
  <title>Life Cell Simulation</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: sans-serif; background: #f9f9f9; padding: 20px; }
    h1 { margin-bottom: 10px; }
    .controls { margin-bottom: 20px; }
    .label { display: inline-block; width: 150px; font-weight: bold; }
    #status { margin-top: 10px; font-style: italic; }
    canvas { max-width: 100%; height: 300px; background: #fff; border: 1px solid #ccc; }
  </style>
</head>
<body>
  <h1>Life Cell Simulation</h1>

  <div class="controls">
    <label class="label">Charge/Discharge Current (A):</label>
    <input type="range" id="currentSlider" min="-100" max="100" value="0" step="1" oninput="updateCurrentLabel()">
    <span id="currentValue">0</span> A
    <br><br>
    <button onclick="startSim()">Start</button>
    <button onclick="stopSim()">Stop</button>
    <span id="status">Disconnected</span>
  </div>

  <canvas id="chartCanvas"></canvas>

  <script>
    const socket = new WebSocket("ws://localhost:8083");
    const statusLabel = document.getElementById('status');
    const currentSlider = document.getElementById('currentSlider');
    const currentValue = document.getElementById('currentValue');

    let chart, chartData;
    const maxPoints = 200;

    function updateCurrentLabel() {
      currentValue.textContent = currentSlider.value;
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ cmd: "set_current", value: parseFloat(currentSlider.value) }));
      }
    }

    function startSim() {
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ cmd: "start_sim" }));
        statusLabel.textContent = "Running";
      }
    }

    function stopSim() {
      if (socket.readyState === WebSocket.OPEN) {
        socket.send(JSON.stringify({ cmd: "stop_sim" }));
        statusLabel.textContent = "Stopped";
      }
    }

    function setupChart() {
      const ctx = document.getElementById('chartCanvas').getContext('2d');
      chartData = {
        labels: [],
        datasets: [
          { label: 'Voltage (V)', borderColor: 'blue', data: [], yAxisID: 'y' },
          { label: 'SOC (%)', borderColor: 'green', data: [], yAxisID: 'y1' },
          { label: 'Temp (°C)', borderColor: 'red', data: [], yAxisID: 'y2' },
          { label: 'Current (A)', borderColor: 'orange', data: [], yAxisID: 'y3' }
        ]
      };

      chart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          animation: false,
          scales: {
            y: { position: 'left', title: { display: true, text: 'Voltage (V)' } },
            y1: { position: 'right', title: { display: true, text: 'SOC (%)' }, grid: { drawOnChartArea: false } },
            y2: { position: 'left', offset: true, title: { display: true, text: 'Temp (°C)' }, grid: { drawOnChartArea: false } },
            y3: { position: 'right', offset: true, title: { display: true, text: 'Current (A)' }, grid: { drawOnChartArea: false } }
          },
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    function addData(voltage, soc, temp, current) {
      const labels = chartData.labels;
      const now = new Date().toLocaleTimeString();

      labels.push(now);
      chartData.datasets[0].data.push(voltage);
      chartData.datasets[1].data.push(soc);
      chartData.datasets[2].data.push(temp);
      chartData.datasets[3].data.push(current);

      if (labels.length > maxPoints) {
        labels.shift();
        chartData.datasets.forEach(ds => ds.data.shift());
      }

      chart.update('none');
    }

    socket.onopen = () => {
      console.log("Connected to mock cell server");
      statusLabel.textContent = "Connected";
      socket.send(JSON.stringify({ cmd: "get_scales" }));
    };

    socket.onmessage = (event) => {
      const msg = JSON.parse(event.data);
      if (msg.cmd === "state") {
        addData(parseFloat(msg.voltage), parseFloat(msg.soc), parseFloat(msg.temp), parseFloat(msg.current));
      }
      if (msg.cmd === "scales") {
        // Rebuild chart with new scale settings
        const s = msg.scales;
        chart.options.scales.y.min = s.voltage.min;
        chart.options.scales.y.max = s.voltage.max;

        chart.options.scales.y1.min = s.soc.min;
        chart.options.scales.y1.max = s.soc.max;

        chart.options.scales.y2.min = s.temp.min;
        chart.options.scales.y2.max = s.temp.max;

        chart.options.scales.y3.min = s.current.min;
        chart.options.scales.y3.max = s.current.max;

        chart.update();  // Apply new settings
      }

    };

    socket.onclose = () => {
      statusLabel.textContent = "Disconnected";
    };

    setupChart();
  </script>
</body>
</html>
